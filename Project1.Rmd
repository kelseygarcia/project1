---
title: "Project1"
author: "Kelsey Garcia kg29435"
date: "10/26/2021"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
library(tidyverse)
library(readr)
suicide_total <- read_csv("/stor/home/kg29435/project1/suicide_total_deaths.csv")
internet_users <- read_csv("/stor/home/kg29435/project1/internet_users.csv")
happy_whr <- read_csv("/stor/home/kg29435/project1/hapiscore_whr.csv")
```
## 0. Introduction (5  pts)

## 1. Tidying: Rearranging Wide/Long (10 pts)


### Tidying 'internet_users'
```{r}
internet_users <- select(internet_users, -('1959':'2004'),-('2016':'2018'))
head(internet_users)
internet_users_long<-internet_users %>% 
                      pivot_longer(2:12, names_to="year", values_to="internet_users")
head(internet_users_long)
```

### Tidying 'happy_whr'
```{r}
happy_whr <- select(happy_whr, -('2004'),-('2016':'2018'))
head(happy_whr)
happy_whr_long <- happy_whr %>% 
                  pivot_longer(2:12, names_to="year", values_to="happiness_score")
head(happy_whr_long)
```

### Tidying 'suicide_total'
```{r}
suicide_total <- select(suicide_total,-('1989':'2004'))
head(suicide_total)
suicide_total_long <- suicide_total %>%
                      pivot_longer(2:12, names_to="year", values_to="total_suicides")
head(suicide_total_long)
## confirming there's an issue with the suicide_total_long dataset
suicide_total_long %>%
  mutate(total_suicides= as.numeric(total_suicides)) %>% 
  group_by(country) %>% 
  summarize_all(function(x)sum(is.na(x))) %>% 
  filter(country=="United States") ## changing to a numeric vector makes it so all of the US's total_suicides values become NA's because they contain "k" instead of 1,000

## changing the "k"'s to numeric values
suicide_total_long <- suicide_total_long %>% mutate(total_suicides=str_replace(total_suicides, "k","000")) %>% mutate(total_suicides=str_replace(total_suicides,"\\.","")) %>%  mutate(total_suicides= as.numeric(total_suicides))
```

## 2. Joining/Merging (20 pts)

### Calculating distinct country IDs for 'internet_users_long'
- number of distinct countries in each dataset compared to each other and what their unique country IDs were
```{r}
## number of unique IDs from 'happy_whr_long'
anti_join(internet_users_long, happy_whr_long, by=c("country","year")) %>% summarize(n_distinct(country))
## what those unique IDs are compared to 'happy_whr_long'
anti_join(internet_users_long, happy_whr_long, by=c("country","year"))
## number of unique IDs form 'suicide_total_long'
anti_join(internet_users_long, suicide_total_long, by=c("country","year")) %>% summarize(n_distinct(country))
## what those unique IDs are compared to 'suicide_total_long'
anti_join(internet_users_long, suicide_total_long, by=c("country","year"))
```

### Calculating distinct country IDs for 'happy_whr_long'
- number of distinct countries in each dataset compared to each other and what their unique country IDs were

```{r}
## number of unique IDs from 'internet_users_long'
anti_join(happy_whr_long, internet_users_long, by=c("country","year")) %>% summarize(n_distinct(country))
## what those unique IDs compared to 'internet_users_long'
anti_join(happy_whr_long, internet_users_long, by=c("country","year"))
## number of unique IDs from 'suicide_total_long'
anti_join(happy_whr_long, suicide_total_long, by=c("country","year")) %>% summarize(n_distinct(country))
## what those unique IDs are compared to 'suicide_total_long'
anti_join(happy_whr_long, suicide_total_long, by=c("country","year"))
```

### Calculating distinct country IDs for 'suicide_total_long'

- number of distinct countries in each dataset compared to each other and what their unique country IDs were

```{r}
# unique country IDs in 'suicide_total_long'
## number of unique IDs from 'internet_user_long'
anti_join(suicide_total_long, internet_users_long, by=c("country","year")) %>% summarize(n_distinct(country))
## what those unique IDs compared to 'internet_users_long'
anti_join(suicide_total_long, internet_users_long, by=c("country","year"))
## number of unique IDs from 'happy_whr_long'
anti_join(suicide_total_long, happy_whr_long, by=c("country","year")) %>% summarize(n_distinct(country))
## what those unique IDs are compared to 'happy_whr_long'
anti_join(suicide_total_long, happy_whr_long, by=c("country","year"))
```

### Performing the appropriate joins to compile all three datasets
- based on the above information, it will be most effective to perform an inner join to only obtain and analyze countries that have information for all three of the different variables
- why the inner join works best for that
- explain the full join comparison in number of rows lost when an inner join is performed instead
- potentail problems with dropped countries in the joined dataset

```{r}
# stepwise joining of the three datasets
partialjoin <- inner_join(internet_users_long, happy_whr_long, by=c("country","year"))

completejoin <- inner_join(partialjoin, suicide_total_long,by=c("country","year"))

completejoin

# total number of observations/rows - \1,771 observations\
str(completejoin)

# number of id variables in common between all three datasets - \161 countries\
completejoin %>% summarize(n_distinct(country)) 

# what country IDs are shared by all three datasets
completejoin %>% count(country)

# number of observations lost when removing the unique country IDs associated with the various data sets
partialfjoin <- full_join(internet_users_long, happy_whr_long, by=c("country"="year"))

full_join(partialfjoin, suicide_total_long, by=c("country","year")) # gives 4,147 observations
4147-1771 # a loss of 2,376 observations
```

## 3. Wrangling (46 pts)

### Creating a new variable of the percent change in internet use in the US from one year to the next
```{r}
completejoin

completejoin %>% 
  filter(country=="United States") %>% 
  mutate(pct_change_internet_use = (internet_users-lag(internet_users)) / lag(internet_users)) 
```

### Summary Statistics for Each Variable
- group_by(country)
- mean
- sd (user function)
- min
- max

```{r}
completejoin
## obtaining 2 of 5 summary statistics & showing an example of pivoting wider
summarystats <- completejoin %>%
  group_by(country) %>% 
  summarize(mean_internet_users=mean(internet_users),
            stdev_internet_users=sd(internet_users),
            max_internet_users=max(internet_users), 
            min_internet_users=min(internet_users),
            mean_happiness_score=mean(happiness_score),
            stdev_happiness_score=sd(happiness_score),
            max_happiness_score=max(happiness_score),
            min_happiness_score=min(happiness_score),
            mean_total_suicides=mean(total_suicides),
            stdev_total_suicides=sd(total_suicides),
            max_total_suicides=max(total_suicides),
            min_total_suicides=min(total_suicides))
                                                 
summarystats

summarystats %>% 
  pivot_longer(2:13) %>% 
  separate(name, into=c("stat","variable1","variable2")) %>% 
  unite("variable", variable1, variable2, sep=".") %>% 
  pivot_wider(names_from = "variable", values_from = "value")
```
### Table presenting summary stats
first column = country
mean, sd, min, max, n()
```{r}
## Creating a table using gt or kable packages

```

```{r}
## obtaining 1 of the 5 summary stats based on two grouped categorical variables
completejoin %>% group_by(country, year) %>% summarize(n())
```

Provide a two paragraph description of what these summary stats moving forward

```{r}
variablecor <- completejoin %>% 
  select_if(is.numeric) %>% 
  cor(use="pair") %>% 
  as.data.frame %>% 
  rownames_to_column("var1") %>%
  pivot_longer(-1,names_to="var2",values_to="correlation")

variablecor %>% 
  ggplot(aes(var1,var2,fill=correlation)) +
  geom_tile() +
  scale_fill_gradient2(mid="pink",high="orange") + 
  geom_text(aes(label=round(correlation,4)),color = "black", size = 4) + 
  theme(axis.text.x = element_text(angle = 90, hjust=1)) + 
  coord_fixed()
```

### Table presenting summary stats
first column = country
mean, sd, min, max, n()
```{r}
top10happiness<- summarystats %>% 
                  select(1,6:9) %>% slice_max(mean_happiness_score,n=10) %>%
                  rename(Mean=mean_happiness_score,StdDeviation=stdev_happiness_score,
                  Maximum=max_happiness_score,Minimum=min_happiness_score)
library(knitr)

top10happiness %>% 
  kable(digits = 3, align = 'c')
```
## 4. Visualizing (39 pts)
- Create 3 effective, polished plots with ggplot (30 pts)

    - Each plot should have at least 2 geometry layers and at least 2 aesthetic mappings 
    - Each plot should have a title and clean labeling for all mappings
    - Modify the default theme and scales at least once per plot
    - For at least one plot, add more tick marks (x, y, or both) than are given by default
    - For at least one plot, use the stat="summary" function

- Write a supporting paragraph (for each plot) describing what the plot depicts and any relationships/trends that are apparent (9 pts)
    
```{r}
completejoin %>% 
  ggplot(aes(internet_users,fill=year)) +
  geom_histogram(aes(y=..density..), bins=30,color="black",fill="white") +
  geom_density(color="black",alpha=.5) +
  facet_wrap(~year)
```
```{r}
completejoin %>% 
  ggplot(aes(happiness_score,internet_users)) + 
  geom_point() + 
  geom_jitter() + 
  geom_smooth(alpha=.5,color="orange")
```


```{r}
completejoin %>% ggplot(aes(year,happiness_score))+geom_histogram(stat="summary",fun=mean,color="black",fill="pink",alpha=.4)+geom_errorbar(stat="summary",fun.data=mean_se)
```


